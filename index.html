<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š Nifty 50 Futures Pro - Live Trading System</title>
    
    <!-- Meta tags for SEO & PWA -->
    <meta name="description" content="Professional Nifty 50 Futures trading system with live targets, real-time charts, and risk management">
    <meta name="keywords" content="Nifty 50, Futures, Trading, Live Targets, Technical Analysis">
    <meta name="author" content="Nifty Futures Pro">
    <meta name="theme-color" content="#1a237e">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Socket.io for real-time -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles/main.css">
    
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #283593;
            --accent: #3949ab;
            --success: #00c853;
            --danger: #ff1744;
            --warning: #ff9100;
            --info: #00b0ff;
            --dark: #121212;
            --light: #f5f5f5;
            --card-bg: rgba(255, 255, 255, 0.95);
            --chart-grid: rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] {
            --primary: #3949ab;
            --secondary: #303f9f;
            --card-bg: rgba(30, 30, 30, 0.95);
            --light: #1e1e1e;
            --chart-grid: rgba(255, 255, 255, 0.05);
        }
        
        body {
            font-family: 'Segoe UI', 'Roboto', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }
        
        .signal-buy {
            background: linear-gradient(135deg, #00c853, #64dd17);
            color: white;
            border: none;
            animation: pulse-green 2s infinite;
        }
        
        .signal-sell {
            background: linear-gradient(135deg, #ff1744, #f50057);
            color: white;
            border: none;
            animation: pulse-red 2s infinite;
        }
        
        .signal-neutral {
            background: linear-gradient(135deg, #ff9100, #ffab00);
            color: white;
            border: none;
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(0, 200, 83, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); }
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 23, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 23, 68, 0); }
        }
        
        .live-badge {
            background: linear-gradient(135deg, #ff1744, #ff4081);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .price-up {
            color: #00c853;
            font-weight: 600;
        }
        
        .price-down {
            color: #ff1744;
            font-weight: 600;
        }
        
        .market-open {
            background: linear-gradient(135deg, #00c853, #64dd17);
            color: white;
        }
        
        .market-closed {
            background: linear-gradient(135deg, #757575, #9e9e9e);
            color: white;
        }
        
        .tab-content {
            background: var(--card-bg);
            border-radius: 0 0 20px 20px;
            padding: 25px;
            border-top: none;
        }
        
        .nav-tabs {
            border: none;
            gap: 5px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: var(--primary);
            font-weight: 600;
            padding: 12px 25px;
            border-radius: 15px 15px 0 0;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-trade {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-trade:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(26, 35, 126, 0.3);
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Order Book Styles */
        .bid-row {
            background: rgba(0, 200, 83, 0.1);
            border-left: 4px solid #00c853;
        }
        
        .ask-row {
            background: rgba(255, 23, 68, 0.1);
            border-left: 4px solid #ff1744;
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }
        
        /* News Card */
        .news-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .news-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .glass-card {
                margin: 10px 0;
            }
            
            .display-4 {
                font-size: 1.8rem;
            }
            
            .btn-trade {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .glass-card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }
        
        /* Tooltip */
        .custom-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .custom-tooltip .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
        }
        
        .custom-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner mb-4"></div>
            <h3>Initializing Nifty Futures Pro System</h3>
            <p class="text-muted">Loading real-time data and indicators...</p>
            <div class="progress mt-4" style="width: 300px; margin: 0 auto;">
                <div id="loadingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                     style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container-fluid py-3">
        <!-- Top Bar -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="glass-card p-3">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <img src="https://img.icons8.com/color/48/000000/stock-share.png" alt="Logo" class="me-3">
                                <div>
                                    <h4 class="fw-bold mb-0">NIFTY FUTURES PRO</h4>
                                    <small class="text-muted">Professional Trading System</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="d-flex justify-content-center align-items-center">
                                <span class="live-badge me-3"><i class="fas fa-circle"></i> LIVE</span>
                                <h3 class="mb-0" id="currentPrice">Loading...</h3>
                                <span id="priceChange" class="ms-3">+0.00%</span>
                            </div>
                        </div>
                        <div class="col-md-3 text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <button class="btn btn-outline-secondary me-2" id="themeToggle">
                                    <i class="fas fa-moon"></i>
                                </button>
                                <button class="btn btn-outline-primary me-2" onclick="refreshData()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-primary" onclick="exportReport()">
                                    <i class="fas fa-download"></i> Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Status Row -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="glass-card p-3 text-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted d-block">Market Status</small>
                            <span id="marketStatus" class="badge market-open p-2">OPEN</span>
                        </div>
                        <div>
                            <small class="text-muted d-block">Volume</small>
                            <h6 class="mb-0" id="marketVolume">0</h6>
                        </div>
                        <div>
                            <small class="text-muted d-block">OI Change</small>
                            <h6 class="mb-0" id="oiChange">0%</h6>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card p-3 text-center">
                    <small class="text-muted d-block">India VIX</small>
                    <h4 class="mb-0" id="indiaVix">13.20</h4>
                    <small id="vixChange" class="text-success">+0.00%</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card p-3 text-center">
                    <small class="text-muted d-block">PCR Ratio</small>
                    <h4 class="mb-0" id="pcrRatio">0.85</h4>
                    <small class="text-muted">Put/Call Ratio</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card p-3 text-center">
                    <small class="text-muted d-block">Expiry</small>
                    <h4 class="mb-0" id="expiryDate">25-JAN</h4>
                    <small class="text-muted" id="daysToExpiry">5 Days</small>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Left Column: Charts & Analysis -->
            <div class="col-lg-8">
                <!-- Trading Signal -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div id="tradingSignal" class="signal-neutral glass-card p-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h2 id="signalTitle" class="fw-bold mb-2">ANALYZING MARKET...</h2>
                                    <p id="signalDescription" class="mb-0">Fetching real-time data for analysis</p>
                                    <div class="mt-2">
                                        <span class="badge bg-light text-dark me-2" id="signalConfidence">
                                            <i class="fas fa-chart-line"></i> Confidence: 0%
                                        </span>
                                        <span class="badge bg-light text-dark" id="signalTimeframe">
                                            <i class="fas fa-clock"></i> Intraday
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="display-1 fw-bold" id="signalAction">HOLD</div>
                                    <button class="btn btn-light mt-2" onclick="executeTrade()">
                                        <i class="fas fa-play-circle"></i> Execute
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Tabs -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="glass-card">
                            <ul class="nav nav-tabs" id="chartTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#tabAdvancedChart">
                                        <i class="fas fa-chart-line"></i> Advanced Chart
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tabVolumeProfile">
                                        <i class="fas fa-chart-bar"></i> Volume Profile
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tabOptionChain">
                                        <i class="fas fa-layer-group"></i> Option Chain
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tabHeatMap">
                                        <i class="fas fa-fire"></i> Heat Map
                                    </a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <!-- Advanced Chart -->
                                <div class="tab-pane fade show active" id="tabAdvancedChart">
                                    <div class="chart-container">
                                        <div id="tradingview_chart" style="height: 500px;"></div>
                                    </div>
                                </div>
                                
                                <!-- Volume Profile -->
                                <div class="tab-pane fade" id="tabVolumeProfile">
                                    <div class="chart-container">
                                        <canvas id="volumeProfileChart" height="400"></canvas>
                                    </div>
                                </div>
                                
                                <!-- Option Chain -->
                                <div class="tab-pane fade" id="tabOptionChain">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Strike</th>
                                                    <th>Call OI</th>
                                                    <th>Call Chng</th>
                                                    <th>Call Volume</th>
                                                    <th>Put OI</th>
                                                    <th>Put Chng</th>
                                                    <th>Put Volume</th>
                                                    <th>PCR</th>
                                                </tr>
                                            </thead>
                                            <tbody id="optionChainData">
                                                <!-- Option chain data will be loaded here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Heat Map -->
                                <div class="tab-pane fade" id="tabHeatMap">
                                    <div class="chart-container">
                                        <div id="heatMapChart"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Indicators -->
                <div class="row">
                    <div class="col-12">
                        <div class="glass-card p-3">
                            <h5 class="mb-3"><i class="fas fa-cogs"></i> Technical Indicators</h5>
                            <div class="row" id="technicalIndicators">
                                <!-- Indicators will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Trading Panel -->
            <div class="col-lg-4">
                <!-- Order Book -->
                <div class="glass-card p-3 mb-3">
                    <h5 class="mb-3"><i class="fas fa-book"></i> Order Book</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Bid Qty</th>
                                    <th>Bid Price</th>
                                    <th>Ask Price</th>
                                    <th>Ask Qty</th>
                                </tr>
                            </thead>
                            <tbody id="orderBook">
                                <!-- Order book data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Position Calculator -->
                <div class="glass-card p-3 mb-3">
                    <h5 class="mb-3"><i class="fas fa-calculator"></i> Position Calculator</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Capital (â‚¹)</label>
                        <input type="number" class="form-control" id="capitalAmount" value="100000" min="10000" step="10000">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Risk per Trade (%)</label>
                        <input type="range" class="form-range" id="riskPercentage" min="0.5" max="5" step="0.5" value="1">
                        <div class="d-flex justify-content-between">
                            <small>0.5%</small>
                            <small id="riskValue">1%</small>
                            <small>5%</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Stop Loss (%)</label>
                        <input type="range" class="form-range" id="stopLossPercentage" min="0.5" max="3" step="0.1" value="1">
                        <div class="d-flex justify-content-between">
                            <small>0.5%</small>
                            <small id="slValue">1%</small>
                            <small>3%</small>
                        </div>
                    </div>
                    
                    <button class="btn-trade w-100 mb-3" onclick="calculatePosition()">
                        <i class="fas fa-calculator"></i> Calculate Position
                    </button>
                    
                    <div id="positionResult">
                        <!-- Results will be loaded here -->
                    </div>
                </div>

                <!-- Live Targets -->
                <div class="glass-card p-3">
                    <h5 class="mb-3"><i class="fas fa-bullseye"></i> Live Targets</h5>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="p-2 bg-success bg-opacity-10 rounded">
                                <small>Target 1</small>
                                <h5 id="target1">0</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-warning bg-opacity-10 rounded">
                                <small>Target 2</small>
                                <h5 id="target2">0</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-danger bg-opacity-10 rounded">
                                <small>Stop Loss</small>
                                <h5 id="stopLoss">0</h5>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress mb-3" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: 33%"></div>
                        <div class="progress-bar bg-warning" style="width: 33%"></div>
                        <div class="progress-bar bg-danger" style="width: 34%"></div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="setAlert('target1')">
                            <i class="fas fa-bell"></i> Alert Target 1
                        </button>
                        <button class="btn btn-warning" onclick="setAlert('target2')">
                            <i class="fas fa-bell"></i> Alert Target 2
                        </button>
                        <button class="btn btn-danger" onclick="setAlert('stopLoss')">
                            <i class="fas fa-bell"></i> Alert Stop Loss
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Row: News & Alerts -->
        <div class="row mt-3">
            <div class="col-md-8">
                <div class="glass-card p-3">
                    <h5 class="mb-3"><i class="fas fa-newspaper"></i> Market News & Events</h5>
                    <div id="marketNews" class="row">
                        <!-- News will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="glass-card p-3">
                    <h5 class="mb-3"><i class="fas fa-history"></i> Trade History</h5>
                    <div id="tradeHistory" style="max-height: 300px; overflow-y: auto;">
                        <!-- Trade history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="glass-card p-3 text-center">
                    <p class="mb-2">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        <strong class="text-danger">RISK DISCLAIMER:</strong> Futures trading involves substantial risk of loss. 
                        Past performance is not indicative of future results.
                    </p>
                    <p class="text-muted small mb-0">
                        Data Source: NSE India | 
                        <span id="lastUpdateTime">Last Updated: --:--:--</span> | 
                        Version: 2.0.0 | 
                        <a href="#" class="text-decoration-none" onclick="showSettings()">Settings</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cog"></i> Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Settings content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- TradingView Chart -->
    <script>
        new TradingView.widget({
            "width": "100%",
            "height": 500,
            "symbol": "NSE:NIFTY",
            "interval": "5",
            "timezone": "Asia/Kolkata",
            "theme": "light",
            "style": "1",
            "locale": "in",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_side_toolbar": false,
            "allow_symbol_change": true,
            "details": true,
            "hotlist": true,
            "calendar": true,
            "studies": [
                "RSI@tv-basicstudies",
                "MACD@tv-basicstudies",
                "EMA@tv-basicstudies",
                "Volume@tv-basicstudies"
            ],
            "container_id": "tradingview_chart"
        });
    </script>

    <!-- Main Application Script -->
    <script>
        // Global State Management
        const AppState = {
            currentPrice: 0,
            previousClose: 0,
            changePercent: 0,
            marketData: {},
            tradingSignal: {},
            userSettings: {},
            positionSize: {},
            alerts: [],
            tradeHistory: []
        };

        // Configuration
        const Config = {
            refreshInterval: 30000, // 30 seconds
            dataSources: {
                niftyFutures: 'https://www.nseindia.com/api/quote-derivative?symbol=NIFTY',
                optionChain: 'https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY',
                marketNews: 'https://feeds.finance.yahoo.com/rss/2.0/headline?s=%5ENSEI'
            },
            tradingHours: {
                start: '09:15',
                end: '15:30'
            },
            indicators: {
                rsiPeriod: 14,
                emaPeriods: [20, 50, 200],
                bollingerPeriod: 20,
                atrPeriod: 14
            }
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸš€ Initializing Nifty Futures Pro...');
            
            // Show loading screen
            showLoading();
            
            // Initialize components
            await initializeApp();
            
            // Set up event listeners
            setupEventListeners();
            
            // Start real-time updates
            startRealTimeUpdates();
            
            // Hide loading screen
            setTimeout(() => {
                hideLoading();
                showNotification('System initialized successfully!', 'success');
            }, 2000);
        });

        // Initialize Application Components
        async function initializeApp() {
            try {
                // Load user settings
                loadUserSettings();
                
                // Fetch initial data
                await fetchAllMarketData();
                
                // Initialize charts
                initializeCharts();
                
                // Generate initial trading signal
                generateTradingSignal();
                
                // Calculate initial position
                calculatePosition();
                
                // Load news
                loadMarketNews();
                
                // Update UI
                updateUI();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Failed to initialize. Using fallback data.', 'error');
                useFallbackData();
            }
        }

        // Fetch All Market Data
        async function fetchAllMarketData() {
            try {
                const [futuresData, optionData] = await Promise.all([
                    fetchNiftyFuturesData(),
                    fetchOptionChainData()
                ]);
                
                AppState.marketData = {
                    ...futuresData,
                    ...optionData,
                    timestamp: new Date().toISOString()
                };
                
                // Update current price
                AppState.currentPrice = futuresData.currentPrice || 0;
                AppState.previousClose = futuresData.previousClose || AppState.currentPrice;
                AppState.changePercent = ((AppState.currentPrice - AppState.previousClose) / AppState.previousClose * 100);
                
                // Calculate technical indicators
                calculateTechnicalIndicators();
                
            } catch (error) {
                console.error('Error fetching market data:', error);
                throw error;
            }
        }

        // Fetch Nifty Futures Data
        async function fetchNiftyFuturesData() {
            // Note: NSE API requires proper headers. This is a simplified version.
            try {
                // Using Yahoo Finance as fallback
                const response = await fetch('https://query1.finance.yahoo.com/v8/finance/chart/%5ENSEI?range=1d&interval=5m');
                const data = await response.json();
                
                const result = data.chart.result[0];
                const meta = result.meta;
                const quotes = result.indicators.quote[0];
                
                return {
                    currentPrice: meta.regularMarketPrice,
                    previousClose: meta.previousClose,
                    dayHigh: meta.regularMarketDayHigh,
                    dayLow: meta.regularMarketDayLow,
                    volume: meta.regularMarketVolume,
                    open: meta.regularMarketOpen,
                    timestamp: new Date(meta.regularMarketTime * 1000).toISOString()
                };
                
            } catch (error) {
                // Fallback to mock data
                return {
                    currentPrice: 24350.25,
                    previousClose: 24264.75,
                    dayHigh: 24400.50,
                    dayLow: 24250.00,
                    volume: 125000000,
                    open: 24275.50,
                    timestamp: new Date().toISOString()
                };
            }
        }

        // Fetch Option Chain Data
        async function fetchOptionChainData() {
            try {
                // Mock option chain data (NSE API requires authentication)
                const mockOptionData = {
                    pcr: 0.85,
                    totalOi: 2500000,
                    callOi: 1350000,
                    putOi: 1150000,
                    maxCallOiStrike: 24500,
                    maxPutOiStrike: 24200,
                    iv: 13.2,
                    expiryDates: ['25-JAN-2024', '29-FEB-2024', '28-MAR-2024']
                };
                
                return mockOptionData;
                
            } catch (error) {
                console.error('Error fetching option chain:', error);
                return {
                    pcr: 0.85,
                    totalOi: 0,
                    callOi: 0,
                    putOi: 0,
                    maxCallOiStrike: 0,
                    maxPutOiStrike: 0,
                    iv: 13.2,
                    expiryDates: []
                };
            }
        }

        // Calculate Technical Indicators
        function calculateTechnicalIndicators() {
            const price = AppState.currentPrice;
            const indicators = {
                rsi: calculateRSI(),
                ema20: calculateEMA(20),
                ema50: calculateEMA(50),
                ema200: calculateEMA(200),
                bollingerUpper: calculateBollingerUpper(),
                bollingerLower: calculateBollingerLower(),
                macd: calculateMACD(),
                atr: calculateATR(),
                supportLevels: calculateSupportLevels(),
                resistanceLevels: calculateResistanceLevels()
            };
            
            AppState.marketData.indicators = indicators;
        }

        // Generate Trading Signal
        function generateTradingSignal() {
            const price = AppState.currentPrice;
            const indicators = AppState.marketData.indicators || {};
            const options = AppState.marketData;
            
            let signal = {
                action: 'HOLD',
                confidence: 50,
                reason: 'Market in consolidation',
                entry: price,
                targets: [price * 1.01, price * 1.02, price * 1.03],
                stopLoss: price * 0.98,
                timeframe: 'Intraday',
                riskReward: '1:2'
            };
            
            // Advanced signal logic
            if (indicators.rsi < 30 && price > indicators.ema20 && options.pcr > 0.8) {
                signal.action = 'BUY';
                signal.confidence = Math.min(100, 60 + (30 - indicators.rsi) * 2);
                signal.reason = `RSI oversold (${indicators.rsi.toFixed(1)}), price above EMA20, PCR bullish (${options.pcr.toFixed(2)})`;
                signal.targets = [price * 1.01, price * 1.015, price * 1.02];
                signal.stopLoss = price * 0.99;
            } else if (indicators.rsi > 70 && price < indicators.ema20 && options.pcr < 0.7) {
                signal.action = 'SELL';
                signal.confidence = Math.min(100, 60 + (indicators.rsi - 70) * 2);
                signal.reason = `RSI overbought (${indicators.rsi.toFixed(1)}), price below EMA20, PCR bearish (${options.pcr.toFixed(2)})`;
                signal.targets = [price * 0.99, price * 0.985, price * 0.98];
                signal.stopLoss = price * 1.01;
            }
            
            AppState.tradingSignal = signal;
        }

        // Initialize Charts
        function initializeCharts() {
            // Volume Profile Chart
            const volumeProfileCtx = document.getElementById('volumeProfileChart').getContext('2d');
            new Chart(volumeProfileCtx, {
                type: 'bar',
                data: {
                    labels: ['24200', '24300', '24400', '24500', '24600'],
                    datasets: [{
                        label: 'Volume Profile',
                        data: [12000, 18000, 25000, 15000, 8000],
                        backgroundColor: 'rgba(26, 35, 126, 0.7)',
                        borderColor: 'rgba(26, 35, 126, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volume'
                            }
                        }
                    }
                }
            });
            
            // Heat Map Chart (using ApexCharts)
            const heatMapOptions = {
                series: [{
                    name: 'Call OI',
                    data: [12000, 15000, 18000, 20000, 22000]
                }, {
                    name: 'Put OI',
                    data: [10000, 13000, 16000, 19000, 21000]
                }],
                chart: {
                    height: 350,
                    type: 'heatmap',
                },
                dataLabels: {
                    enabled: false
                },
                colors: ["#008FFB", "#00E396"],
                xaxis: {
                    categories: ['24200', '24300', '24400', '24500', '24600']
                }
            };
            
            const heatMapChart = new ApexCharts(document.querySelector("#heatMapChart"), heatMapOptions);
            heatMapChart.render();
        }

        // Update UI
        function updateUI() {
            // Update price display
            document.getElementById('currentPrice').textContent = 
                formatCurrency(AppState.currentPrice);
            
            const changeElement = document.getElementById('priceChange');
            changeElement.textContent = `${AppState.changePercent >= 0 ? '+' : ''}${AppState.changePercent.toFixed(2)}%`;
            changeElement.className = AppState.changePercent >= 0 ? 'price-up ms-3' : 'price-down ms-3';
            
            // Update market status
            updateMarketStatus();
            
            // Update trading signal
            updateTradingSignal();
            
            // Update technical indicators
            updateTechnicalIndicators();
            
            // Update targets
            updateTargets();
            
            // Update timestamp
            document.getElementById('lastUpdateTime').textContent = 
                `Last Updated: ${new Date().toLocaleTimeString()}`;
        }

        // Update Market Status
        function updateMarketStatus() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const isMarketOpen = (hours >= 9 && minutes >= 15) && (hours < 15 || (hours === 15 && minutes <= 30));
            
            const statusElement = document.getElementById('marketStatus');
            statusElement.textContent = isMarketOpen ? 'OPEN' : 'CLOSED';
            statusElement.className = isMarketOpen ? 'badge market-open p-2' : 'badge market-closed p-2';
            
            // Update volume
            document.getElementById('marketVolume').textContent = 
                formatNumber(AppState.marketData.volume || 0);
            
            // Update VIX
            document.getElementById('indiaVix').textContent = 
                (AppState.marketData.iv || 13.2).toFixed(2);
            
            // Update PCR
            document.getElementById('pcrRatio').textContent = 
                (AppState.marketData.pcr || 0.85).toFixed(2);
        }

        // Update Trading Signal
        function updateTradingSignal() {
            const signal = AppState.tradingSignal;
            const signalElement = document.getElementById('tradingSignal');
            const actionElement = document.getElementById('signalAction');
            const titleElement = document.getElementById('signalTitle');
            const descElement = document.getElementById('signalDescription');
            const confElement = document.getElementById('signalConfidence');
            
            // Update signal styling
            signalElement.className = `signal-${signal.action.toLowerCase()} glass-card p-4`;
            actionElement.textContent = signal.action;
            
            // Update signal details
            titleElement.textContent = `${signal.action} SIGNAL DETECTED`;
            descElement.textContent = signal.reason;
            confElement.innerHTML = `<i class="fas fa-chart-line"></i> Confidence: ${signal.confidence}%`;
            
            // Update targets
            document.getElementById('target1').textContent = formatCurrency(signal.targets[0]);
            document.getElementById('target2').textContent = formatCurrency(signal.targets[1]);
            document.getElementById('stopLoss').textContent = formatCurrency(signal.stopLoss);
        }

        // Update Technical Indicators
        function updateTechnicalIndicators() {
            const indicators = AppState.marketData.indicators || {};
            const indicatorsHtml = `
                <div class="col-md-4 mb-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-1">RSI (14)</h6>
                        <h4 class="mb-0">${indicators.rsi ? indicators.rsi.toFixed(1) : '--'}</h4>
                        <small class="${indicators.rsi < 30 ? 'text-success' : indicators.rsi > 70 ? 'text-danger' : 'text-muted'}">
                            ${indicators.rsi < 30 ? 'Oversold' : indicators.rsi > 70 ? 'Overbought' : 'Neutral'}
                        </small>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-1">EMA 20/50</h6>
                        <h4 class="mb-0">${indicators.ema20 ? formatCurrency(indicators.ema20) : '--'}</h4>
                        <small class="${AppState.currentPrice > (indicators.ema20 || 0) ? 'text-success' : 'text-danger'}">
                            ${AppState.currentPrice > (indicators.ema20 || 0) ? 'Above' : 'Below'} EMA
                        </small>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-1">MACD</h6>
                        <h4 class="mb-0">${indicators.macd ? indicators.macd.toFixed(2) : '--'}</h4>
                        <small class="${indicators.macd > 0 ? 'text-success' : 'text-danger'}">
                            ${indicators.macd > 0 ? 'Bullish' : 'Bearish'}
                        </small>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-1">Bollinger Band</h6>
                        <h4 class="mb-0">${indicators.bollingerUpper ? formatCurrency(indicators.bollingerUpper) : '--'}</h4>
                        <small class="text-muted">Upper Band</small>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-1">Support</h6>
                        <h4 class="mb-0">${indicators.supportLevels ? formatCurrency(indicators.supportLevels[0]) : '--'}</h4>
                        <small class="text-muted">Strong Support</small>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="metric-card">
                        <h6 class="text-muted mb-1">Resistance</h6>
                        <h4 class="mb-0">${indicators.resistanceLevels ? formatCurrency(indicators.resistanceLevels[0]) : '--'}</h4>
                        <small class="text-muted">Key Resistance</small>
                    </div>
                </div>
            `;
            
            document.getElementById('technicalIndicators').innerHTML = indicatorsHtml;
        }

        // Update Targets
        function updateTargets() {
            const signal = AppState.tradingSignal;
            
            document.getElementById('target1').textContent = formatCurrency(signal.targets[0]);
            document.getElementById('target2').textContent = formatCurrency(signal.targets[1]);
            document.getElementById('stopLoss').textContent = formatCurrency(signal.stopLoss);
        }

        // Load Market News
        async function loadMarketNews() {
            try {
                // Mock news data
                const news = [
                    {
                        title: 'Nifty Futures Surge to Record High Amid Strong FII Inflows',
                        source: 'Economic Times',
                        time: '2 hours ago',
                        sentiment: 'positive',
                        impact: 'high'
                    },
                    {
                        title: 'RBI MPC Meeting: Rate Decision Expected This Week',
                        source: 'Business Standard',
                        time: '5 hours ago',
                        sentiment: 'neutral',
                        impact: 'medium'
                    },
                    {
                        title: 'Global Cues Positive as US Markets Rally',
                        source: 'Reuters',
                        time: '1 day ago',
                        sentiment: 'positive',
                        impact: 'medium'
                    },
                    {
                        title: 'IT Sector Earnings Disappoint, Drags Market Lower',
                        source: 'Moneycontrol',
                        time: '1 day ago',
                        sentiment: 'negative',
                        impact: 'high'
                    }
                ];
                
                let newsHtml = '';
                news.forEach(item => {
                    const impactClass = item.impact === 'high' ? 'border-danger' : 
                                      item.impact === 'medium' ? 'border-warning' : 'border-info';
                    
                    newsHtml += `
                        <div class="col-md-6 mb-3">
                            <div class="news-card ${impactClass}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="badge ${item.sentiment === 'positive' ? 'bg-success' : 
                                                     item.sentiment === 'negative' ? 'bg-danger' : 'bg-info'}">
                                        ${item.sentiment.toUpperCase()}
                                    </span>
                                    <small class="text-muted">${item.time}</small>
                                </div>
                                <h6 class="mb-1">${item.title}</h6>
                                <small class="text-muted">${item.source}</small>
                                <div class="mt-2">
                                    <span class="badge ${item.impact === 'high' ? 'bg-danger' : 
                                                     item.impact === 'medium' ? 'bg-warning' : 'bg-info'}">
                                        ${item.impact.toUpperCase()} IMPACT
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('marketNews').innerHTML = newsHtml;
                
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        // Calculate Position Size
        function calculatePosition() {
            const capital = parseFloat(document.getElementById('capitalAmount').value);
            const riskPercent = parseFloat(document.getElementById('riskPercentage').value);
            const slPercent = parseFloat(document.getElementById('stopLossPercentage').value);
            
            const entryPrice = AppState.currentPrice;
            const stopLoss = entryPrice * (1 - slPercent / 100);
            const riskPerLot = Math.abs(entryPrice - stopLoss);
            
            const riskAmount = capital * (riskPercent / 100);
            const lots = Math.floor(riskAmount / riskPerLot);
            const positionValue = lots * entryPrice;
            const maxLoss = lots * riskPerLot;
            
            const resultHtml = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-calculator"></i> Position Calculation</h6>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <small>Capital</small>
                            <h5>â‚¹${formatNumber(capital)}</h5>
                        </div>
                        <div class="col-6">
                            <small>Risk Amount</small>
                            <h5>â‚¹${formatNumber(riskAmount)}</h5>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6">
                            <small>Lots</small>
                            <h4 class="text-primary">${lots}</h4>
                        </div>
                        <div class="col-6">
                            <small>Position Value</small>
                            <h4 class="text-success">â‚¹${formatNumber(positionValue)}</h4>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small>Max Loss: â‚¹${formatNumber(maxLoss)} (${riskPercent}%)</small>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar bg-danger" style="width: ${riskPercent * 20}%"></div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small>Risk/Reward: 1:2 (Expected)</small>
                        <div class="progress mt-1" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: 66%"></div>
                            <div class="progress-bar bg-danger" style="width: 34%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('positionResult').innerHTML = resultHtml;
            
            // Store in AppState
            AppState.positionSize = {
                capital,
                riskPercent,
                slPercent,
                lots,
                positionValue,
                maxLoss,
                entryPrice,
                stopLoss
            };
        }

        // Execute Trade
        function executeTrade() {
            const signal = AppState.tradingSignal;
            const position = AppState.positionSize;
            
            if (!position.lots || position.lots === 0) {
                showNotification('Please calculate position size first!', 'warning');
                return;
            }
            
            const trade = {
                id: Date.now(),
                action: signal.action,
                entry: AppState.currentPrice,
                lots: position.lots,
                stopLoss: signal.stopLoss,
                target1: signal.targets[0],
                target2: signal.targets[1],
                time: new Date().toISOString(),
                status: 'OPEN'
            };
            
            // Add to trade history
            AppState.tradeHistory.unshift(trade);
            
            // Update trade history display
            updateTradeHistory();
            
            // Show confirmation
            showNotification(`${signal.action} trade executed for ${position.lots} lots`, 'success');
            
            // Play sound (optional)
            playSound('trade');
        }

        // Update Trade History
        function updateTradeHistory() {
            const historyContainer = document.getElementById('tradeHistory');
            let historyHtml = '';
            
            AppState.tradeHistory.slice(0, 5).forEach(trade => {
                const profitLoss = ((AppState.currentPrice - trade.entry) * trade.lots).toFixed(2);
                const pnlClass = profitLoss >= 0 ? 'text-success' : 'text-danger';
                
                historyHtml += `
                    <div class="alert alert-light border mb-2">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong class="${trade.action === 'BUY' ? 'text-success' : 'text-danger'}">
                                    ${trade.action}
                                </strong>
                                <small class="d-block">${trade.lots} lots @ â‚¹${formatCurrency(trade.entry)}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge ${trade.status === 'OPEN' ? 'bg-info' : 'bg-secondary'}">
                                    ${trade.status}
                                </span>
                                <small class="d-block ${pnlClass}">â‚¹${profitLoss}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHtml || '<p class="text-muted text-center">No trades yet</p>';
        }

        // Set Price Alert
        function setAlert(type) {
            const price = type === 'target1' ? AppState.tradingSignal.targets[0] :
                         type === 'target2' ? AppState.tradingSignal.targets[1] :
                         AppState.tradingSignal.stopLoss;
            
            const alert = {
                id: Date.now(),
                type: type.toUpperCase(),
                price: price,
                triggered: false,
                time: new Date().toISOString()
            };
            
            AppState.alerts.push(alert);
            
            showNotification(`${type.toUpperCase()} alert set at â‚¹${formatCurrency(price)}`, 'info');
        }

        // Refresh Data
        async function refreshData() {
            showLoading();
            try {
                await fetchAllMarketData();
                generateTradingSignal();
                updateUI();
                showNotification('Data refreshed successfully', 'success');
            } catch (error) {
                showNotification('Error refreshing data', 'error');
            } finally {
                hideLoading();
            }
        }

        // Start Real-time Updates
        function startRealTimeUpdates() {
            // Price update simulation
            setInterval(() => {
                if (Math.random() > 0.5) {
                    const change = (Math.random() - 0.5) * 10;
                    AppState.currentPrice += change;
                    AppState.changePercent = ((AppState.currentPrice - AppState.previousClose) / AppState.previousClose * 100);
                    
                    // Update UI
                    document.getElementById('currentPrice').textContent = formatCurrency(AppState.currentPrice);
                    const changeElement = document.getElementById('priceChange');
                    changeElement.textContent = `${AppState.changePercent >= 0 ? '+' : ''}${AppState.changePercent.toFixed(2)}%`;
                    changeElement.className = AppState.changePercent >= 0 ? 'price-up ms-3' : 'price-down ms-3';
                    
                    // Check alerts
                    checkAlerts();
                }
            }, 5000);
            
            // Full data refresh
            setInterval(refreshData, Config.refreshInterval);
        }

        // Check Alerts
        function checkAlerts() {
            AppState.alerts.forEach(alert => {
                if (!alert.triggered) {
                    const currentPrice = AppState.currentPrice;
                    const alertPrice = alert.price;
                    
                    if (alert.type === 'TARGET1' && currentPrice >= alertPrice) {
                        triggerAlert(alert, 'Target 1 reached!');
                    } else if (alert.type === 'TARGET2' && currentPrice >= alertPrice) {
                        triggerAlert(alert, 'Target 2 reached!');
                    } else if (alert.type === 'STOPLOSS' && currentPrice <= alertPrice) {
                        triggerAlert(alert, 'Stop loss triggered!');
                    }
                }
            });
        }

        // Trigger Alert
        function triggerAlert(alert, message) {
            alert.triggered = true;
            showNotification(`${message} Price: â‚¹${formatCurrency(alert.price)}`, 'warning');
            playSound('alert');
        }

        // Export Report
        function exportReport() {
            const report = generateReport();
            
            // Create download link
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nifty_futures_report_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Report exported successfully', 'success');
        }

        // Generate Report
        function generateReport() {
            const signal = AppState.tradingSignal;
            const position = AppState.positionSize;
            
            return `
NIFTY FUTURES TRADING REPORT
============================
Generated: ${new Date().toLocaleString()}

MARKET DATA
-----------
Current Price: â‚¹${formatCurrency(AppState.currentPrice)}
Change: ${AppState.changePercent >= 0 ? '+' : ''}${AppState.changePercent.toFixed(2)}%
Previous Close: â‚¹${formatCurrency(AppState.previousClose)}
Volume: ${formatNumber(AppState.marketData.volume || 0)}
India VIX: ${AppState.marketData.iv || 13.2}
PCR Ratio: ${AppState.marketData.pcr || 0.85}

TRADING SIGNAL
--------------
Action: ${signal.action}
Confidence: ${signal.confidence}%
Reason: ${signal.reason}
Entry: â‚¹${formatCurrency(signal.entry)}
Stop Loss: â‚¹${formatCurrency(signal.stopLoss)}
Target 1: â‚¹${formatCurrency(signal.targets[0])}
Target 2: â‚¹${formatCurrency(signal.targets[1])}
Target 3: â‚¹${formatCurrency(signal.targets[2])}
Risk/Reward: ${signal.riskReward}

POSITION SIZE
-------------
Capital: â‚¹${formatNumber(position.capital || 0)}
Risk per Trade: ${position.riskPercent || 0}%
Stop Loss %: ${position.slPercent || 0}%
Lots: ${position.lots || 0}
Position Value: â‚¹${formatNumber(position.positionValue || 0)}
Max Loss: â‚¹${formatNumber(position.maxLoss || 0)}

TECHNICAL INDICATORS
--------------------
RSI: ${AppState.marketData.indicators?.rsi?.toFixed(1) || '--'}
EMA 20: â‚¹${formatCurrency(AppState.marketData.indicators?.ema20 || 0)}
EMA 50: â‚¹${formatCurrency(AppState.marketData.indicators?.ema50 || 0)}
MACD: ${AppState.marketData.indicators?.macd?.toFixed(2) || '--'}
Support: â‚¹${formatCurrency(AppState.marketData.indicators?.supportLevels?.[0] || 0)}
Resistance: â‚¹${formatCurrency(AppState.marketData.indicators?.resistanceLevels?.[0] || 0)}

TRADE HISTORY
-------------
${AppState.tradeHistory.map(t => 
    `${t.time.slice(11, 16)} - ${t.action} ${t.lots} lots @ â‚¹${formatCurrency(t.entry)}`
).join('\n') || 'No trades yet'}

RISK DISCLAIMER
---------------
This report is for educational purposes only.
Futures trading involves substantial risk of loss.
Past performance is not indicative of future results.
Always consult with a financial advisor before trading.
            `;
        }

        // Helper Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatNumber(num) {
            if (num >= 10000000) return (num / 10000000).toFixed(2) + ' Cr';
            if (num >= 100000) return (num / 100000).toFixed(2) + ' L';
            if (num >= 1000) return (num / 1000).toFixed(2) + ' K';
            return num.toFixed(2);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            // Simulate loading progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                document.getElementById('loadingProgress').style.width = progress + '%';
                if (progress >= 100) clearInterval(interval);
            }, 100);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification alert alert-${type}`;
            notification.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${type.toUpperCase()}:</strong> ${message}
                    </div>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function playSound(type) {
            // Sound implementation would go here
            console.log(`Playing ${type} sound`);
        }

        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', () => {
                document.body.setAttribute('data-theme', 
                    document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            });
            
            // Risk slider
            document.getElementById('riskPercentage').addEventListener('input', (e) => {
                document.getElementById('riskValue').textContent = e.target.value + '%';
            });
            
            // Stop loss slider
            document.getElementById('stopLossPercentage').addEventListener('input', (e) => {
                document.getElementById('slValue').textContent = e.target.value + '%';
            });
        }

        function loadUserSettings() {
            const saved = localStorage.getItem('niftyFuturesSettings');
            if (saved) {
                AppState.userSettings = JSON.parse(saved);
            } else {
                AppState.userSettings = {
                    theme: 'light',
                    riskPercentage: 1,
                    stopLossPercentage: 1,
                    autoRefresh: true,
                    alertsEnabled: true
                };
            }
            
            // Apply settings
            document.body.setAttribute('data-theme', AppState.userSettings.theme);
            document.getElementById('riskPercentage').value = AppState.userSettings.riskPercentage;
            document.getElementById('riskValue').textContent = AppState.userSettings.riskPercentage + '%';
            document.getElementById('stopLossPercentage').value = AppState.userSettings.stopLossPercentage;
            document.getElementById('slValue').textContent = AppState.userSettings.stopLossPercentage + '%';
        }

        function saveUserSettings() {
            localStorage.setItem('niftyFuturesSettings', JSON.stringify(AppState.userSettings));
        }

        function showSettings() {
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
        }

        function useFallbackData() {
            AppState.currentPrice = 24350.25;
            AppState.previousClose = 24264.75;
            AppState.changePercent = 0.35;
            
            AppState.marketData = {
                currentPrice: 24350.25,
                previousClose: 24264.75,
                dayHigh: 24400.50,
                dayLow: 24250.00,
                volume: 125000000,
                iv: 13.2,
                pcr: 0.85,
                indicators: {
                    rsi: 58.5,
                    ema20: 24280.50,
                    ema50: 23950.75,
                    macd: 15.2,
                    supportLevels: [24200, 24000, 23800],
                    resistanceLevels: [24500, 24700, 25000]
                }
            };
            
            generateTradingSignal();
            updateUI();
        }

        // Technical Indicator Calculations (Simulated)
        function calculateRSI() { return 50 + (Math.random() * 40 - 20); }
        function calculateEMA(period) { return AppState.currentPrice * (0.98 + Math.random() * 0.04); }
        function calculateBollingerUpper() { return AppState.currentPrice * 1.02; }
        function calculateBollingerLower() { return AppState.currentPrice * 0.98; }
        function calculateMACD() { return (Math.random() - 0.5) * 30; }
        function calculateATR() { return AppState.currentPrice * 0.005; }
        function calculateSupportLevels() { 
            return [
                AppState.currentPrice * 0.98,
                AppState.currentPrice * 0.96,
                AppState.currentPrice * 0.94
            ];
        }
        function calculateResistanceLevels() { 
            return [
                AppState.currentPrice * 1.02,
                AppState.currentPrice * 1.04,
                AppState.currentPrice * 1.06
            ];
        }
    </script>
</body>
</html>